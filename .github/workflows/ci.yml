name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, '*-remote-command-executor' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # Lint and format checks
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Python syntax
        run: |
          python3 -m py_compile server_new.py test_integration.py test_security.py || true
      
      - name: Check shell scripts
        run: |
          shellcheck build_windows_exe.sh start_server.sh || true
      
      - name: Validate Makefiles
        run: |
          make -n -f Makefile || true
          make -n -f Makefile.test.c || true

  # Unit tests (C code)
  unit-tests:
    name: C Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc build-essential
      
      - name: Run C unit tests
        run: |
          make -f Makefile.test.c clean
          make -f Makefile.test.c test

  # Integration tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
      
      - name: Run integration tests
        run: |
          python3 test_integration.py

  # Security tests
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc build-essential
      
      - name: Run security tests
        run: |
          python3 test_security.py
        continue-on-error: true  # Don't fail CI on security test issues

  # Cross-compilation test (Windows binary from Linux)
  cross-compile:
    name: Cross-Compile Windows Binary
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install MinGW-w64
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-mingw-w64-x86-64
      
      - name: Cross-compile for Windows
        run: |
          make clean
          make CC=x86_64-w64-mingw32-gcc
      
      - name: Check binary exists
        run: |
          if [ -f remote_command_executor.exe ]; then
            echo "✓ Binary created successfully"
            ls -lh remote_command_executor.exe
          else
            echo "✗ Binary not found"
            exit 1
          fi
      
      - name: Upload artifact (if needed for testing)
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: windows-binary
          path: remote_command_executor.exe
          retention-days: 1  # Short retention for security

  # Build validation
  build-validation:
    name: Build Validation
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc build-essential
      
      - name: Clean build
        run: |
          make clean
      
      - name: Standard build
        run: |
          make
      
      - name: Verify binary
        run: |
          if [ -f remote_command_executor.exe ]; then
            file remote_command_executor.exe
            size=$(stat -c%s remote_command_executor.exe)
            echo "Binary size: $size bytes"
          else
            echo "Error: Binary not created"
            exit 1
          fi

  # Test summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, security-tests, cross-compile]
    if: always()
    steps:
      - name: Test Results Summary
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Tests | ${{ needs.security-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cross-Compile | ${{ needs.cross-compile.result }} |" >> $GITHUB_STEP_SUMMARY
